# ============================================================
# Workflow: Deploy Frontend to Vercel
# ============================================================
# This workflow deploys the Angular application to Vercel.
#
# - Push to main (with changes in src/frontend/) â†’ PRODUCTION deploy
# - Pull Request against main                    â†’ PREVIEW deploy
#
# ============================================================
# PREREQUISITES (one-time manual setup):
#
# 1. Create an account at https://vercel.com (free for personal projects).
# 2. Install the CLI:  npm i -g vercel
# 3. Authenticate:     vercel login
# 4. Link the repo:    vercel link  (from the repo root)
#    â†’ This generates an orgId and projectId (saved in .vercel/project.json)
# 5. Create an API token in Vercel Dashboard â†’ Settings â†’ Tokens.
# 6. Add these 3 secrets in GitHub (Settings â†’ Secrets â†’ Actions):
#    - VERCEL_TOKEN       â†’ the API token
#    - VERCEL_ORG_ID      â†’ orgId from step 4
#    - VERCEL_PROJECT_ID  â†’ projectId from step 4
# 7. (Optional) In Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables:
#    - API_URL = https://chefpro-production.up.railway.app
#    â†’ Update this value if the backend URL changes.
# ============================================================

name: Deploy Frontend to Vercel

on:
  push:
    branches:
      - main
    paths:
      - 'src/frontend/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/frontend/**'
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # â”€â”€â”€ PRODUCTION deploy (push to main or manual trigger) â”€â”€
  deploy-production:
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Inject API_URL into environment.prod.ts
        working-directory: src/frontend
        run: |
          # If API_URL is defined as a GitHub variable,
          # replace the placeholder. Otherwise, use the Railway production URL.
          API="${{ vars.API_URL }}"
          if [ -z "$API" ]; then
            API="https://chefpro-production.up.railway.app"
          fi
          sed -i "s|{API_URL}|${API}|g" src/environments/environment.prod.ts
          echo "âœ… environment.prod.ts configured with apiUrl: $API"
          cat src/environments/environment.prod.ts

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel configuration
        working-directory: src/frontend
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project
        working-directory: src/frontend
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to production
        working-directory: src/frontend
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "ðŸš€ Deployed to: $DEPLOY_URL"
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

  # â”€â”€â”€ PREVIEW deploy (pull requests) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Inject API_URL into environment.prod.ts
        working-directory: src/frontend
        run: |
          API="${{ vars.API_URL }}"
          if [ -z "$API" ]; then
            API="https://chefpro-production.up.railway.app"
          fi
          sed -i "s|{API_URL}|${API}|g" src/environments/environment.prod.ts
          cat src/environments/environment.prod.ts

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel configuration
        working-directory: src/frontend
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project
        working-directory: src/frontend
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy preview
        working-directory: src/frontend
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "ðŸ” Preview URL: $DEPLOY_URL"
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
