# ============================================
# GitHub Actions Workflow: Deploy Backend to Railway
# ============================================
# WHEN it runs:
#   - Every push to the 'main' branch
#   - Only if files in 'src/backend/' have changed
#
# WHAT it does:
#   1. Builds the Java project with Maven
#   2. Runs the tests
#   3. Deploys to Railway using the official CLI
#
# REQUIREMENTS:
#   You need to configure a secret in GitHub:
#     - RAILWAY_TOKEN: Railway API token
#   (Go to Settings > Secrets and variables > Actions > New repository secret)
# ============================================

name: Deploy Backend to Railway

# --- When the workflow is triggered ---
on:
  push:
    branches:
      - main
    # Only runs if backend files change
    paths:
      - 'src/backend/**'
      - 'railway.toml'
  # Can also be triggered manually from the "Actions" tab
  workflow_dispatch:

# --- Jobs ---
jobs:
  # ==============================
  # JOB 1: Build and test
  # ==============================
  build-and-test:
    name: "Build & Test"
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install Java 17
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # Cache Maven dependencies so they are not downloaded every time
          cache: 'maven'
          cache-dependency-path: 'src/backend/pom.xml'

      # Step 3: Compile and run tests
      - name: Build with Maven
        working-directory: src/backend
        run: ./mvnw clean verify -B

  # ==============================
  # JOB 2: Deploy to Railway
  # ==============================
  deploy:
    name: "Deploy to Railway"
    runs-on: ubuntu-latest
    # Only deploys if the build was successful
    needs: build-and-test

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install Railway CLI
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # Step 3: Deploy to Railway
      # The CLI uses RAILWAY_TOKEN to authenticate
      # and railway.toml to know how to build the app
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --detach --service ChefPro
